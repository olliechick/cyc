<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>MAP</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #right-panel {
        font-family: 'Roboto','sans-serif';
        line-height: 20px;
        padding-left: 5px;
        padding-right: 5px;
      }

      #right-panel select, #right-panel input {
        font-size: 11px;
      }

      #right-panel select {
        width: 100%;
      }

      #right-panel  {
        font-size: 11px;
      }
      #right-panel {
        height: 100%;
        float: right;
        width: 180px;
        overflow: auto;
      }
      #map {
        margin-right: 100px;
      }

      @media print {
        #map {
          height: 500px;
          margin: 0;
        }
        #right-panel {
          float: none;
          width: auto;
        }
      }
    </style>
</head>
<body>
<div id="right-panel"></div>
<div id="map"></div>

<script>

    /* Map style, sets visibility of various default map labels and
       icons to off as these distract the user from the apps function
    */
       var mapStyle = [
  {
    featureType: "administrative",
    elementType: "labels",
    stylers: [
      { visibility: "off" }
    ]
  },{
    featureType: "poi",
    elementType: "labels",
    stylers: [
      { visibility: "off" }
    ]
  },{
    featureType: "water",
    elementType: "labels",
    stylers: [
      { visibility: "off" }
    ]
  },{
    featureType: "road",
    elementType: "labels.icon",
    stylers: [
      { visibility: "off" }
    ]
   },
   {
    featureType: "transit",
    elementType: "labels",
    stylers: [
      { visibility: "off" }
    ]
  }
]



    /* Stops info windows from being opened by redefining the set() method for
       Google maps. Infowindows will only be opened if noSupress is true.
    */
    function fixInfoWindow() {
    var set = google.maps.InfoWindow.prototype.set;
    google.maps.InfoWindow.prototype.set = function (key, val) {
        if (key === 'map') {
            if (!this.get('noSupress')) {
                console.log('This InfoWindow is supressed. To enable it, set "noSupress" option to true');
                return;
            }
        }
        set.apply(this, arguments);
    }
  }

      // Map initialization function
      function initMap() {
        var nycLatLng = {lat: 40.759071, lng:  -73.902467};              // initial coordinates, over NYC
           // directions service, used to request route directions
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: nycLatLng,
          disableDefaultUI: true,
          fullscreenControl: false,
          mapTypeControl: false

        });

        //Stop annoying infowindows
        fixInfoWindow();

        //Directions service is used to request bike route directions from Google
        var directionsService = new google.maps.DirectionsService();

        //Directions display renders directions obtained from directionsService
        directionsDisplay = new google.maps.DirectionsRenderer({
         polylineOptions: {
         strokeColor: "red"
         }
         });

        // Bike layer displays a cycle friendly map overlay, showing cycle routes
        var bikeLayer = new google.maps.BicyclingLayer();

        // Set bike layer to our map
        bikeLayer.setMap(map);

        // Set directionsDisplay to map
        directionsDisplay.setMap(map);

        directionsDisplay.setPanel(document.getElementById('right-panel'));

        //Set style to map
        map.set('styles', mapStyle);


        // Set zoom so functions zoomIn and zoomOut can work
        var oldZoom = null;
        var oldCenter = null;
        google.maps.event.addListenerOnce(map, "zoom_changed", function() { oldZoom = map.getZoom(); });
        google.maps.event.addListenerOnce(map, "center_changed", function() { oldCenter = map.getCenter(); });

        // Labels, labelIndex and markerArray to track user clicks on map
        var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var labelIndex = 0;
        var markerArray = [];

        var circleArray = [];

        // WIFI and retailer marker arrays
        var wifiMarkerArray = [];
        var retailerMarkerArray = [];

        // WIFI and retailer clusters
        var wifiMarkerCluster;
        var retailerMarkerCluster;




      // Adds a marker to the map.
      function addMarkerUser(location, map) {
        // Add the marker at the clicked location, and add the next-available label
        // from the array of alphabetical characters.
        var marker = new google.maps.Marker({
          position: location,
          label: labels[labelIndex++ % labels.length],
          map: map
        });

        markerArray[markerArray.length] = marker;;

        // This passes the position of the user click/marker back to mapController


        /* If the user has clicked twice, for start and end of journey then
           request directions and render the result to the map. Then clear marker
           array.
        */

        if (markerArray.length > 1)
        {
            var marker1 = markerArray[0].position;
            var marker2 = markerArray[1].position;
            document.calcRoute(marker1, marker2);
            for (i = 0; i < markerArray.length; i++) {
                    markerArray[i].setMap(null);

             }
             app.alert(marker.position.lat(), marker.position.lng());
             markerArray = [];
        }
        else {
        app.alert(marker.position.lat(), marker.position.lng());
        }
        }


    // Listner for click event on map. Passes click coordinates to addMarkerUser.
    google.maps.event.addListener(map, 'click', function(event) {
          addMarkerUser(event.latLng, map);
        });

    // Draws a route from an array of LatLng literals using polylines
    document.drawRoute = function drawRoute(coordinateArray)
    {
      var newRoute = new google.maps.Polyline({
        path: coordinateArray,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
        });
        newRoute.setMap(map);
    }


   /* Requests a route using start and end LatLng coordinates and renders it using
      using directionsDisplay.
    */
   document.calcRoute = function calcRoute(start, end) {

             var request = {
             origin: start,
             destination: end,
             travelMode: 'BICYCLING'
              };
       directionsService.route(request, function(response, status) {
    if (status == 'OK') {
      directionsDisplay.setDirections(response);
      var myJSON = JSON.stringify(response);
      //document.getElementById("right-panel").innerHTML = myJSON;
      currentRoute = myJSON;
     // currentRoute.setAttribute("map", "currentRoute");
      app.directions(myJSON);

    }
              else {
            window.alert('Directions request failed due to ' + status);
          }
  });
       }

     /* Clusters wifi markers in wifiMarkerArray. Does NOT remove or add
        markers dynamically, to update clusters call updatewifiMarkerCluster.
        Note that updatewifiMarkerCluster must iterate through the entire wifiMarkerArray.
      */
     document.wifiCluster = function wifiCluster()
        {
        wifiMarkerCluster = new MarkerClusterer(map, wifiMarkerArray,
        {imagePath: 'wifiCluster/bluewifi',
         ignoreHiddenMarkers: true,
         zoomOnClick: false,
         maxZoom: 13});
        }


      /* Clusters retailer markers in retailerMarkerArray. Does NOT remove or add
        markers dynamically, to update clusters call updateRetailerMarkerCluster.
        Note that updateRetailerMarkerCluster must iterate through the entire retailerMarkerArray.
      */
    document.retailerCluster = function retailerCluster()
        {
        retailerMarkerCluster = new MarkerClusterer(map, retailerMarkerArray,
        {imagePath: 'retailerCluster/pink',
        ignoreHiddenMarkers: true,
        zoomOnClick: false,
         maxZoom: 15});
        }

    document.circleRetailer = function circleRetailer(index, icon, iconRevert)
    {
        //retailerMarkerArray[index].setVisible(true);
        retailerMarkerArray[index].setIcon(icon);
        setTimeout(function () {
        retailerMarkerArray[index].setIcon(iconRevert);
        }, 100000);

    }


    document.circleWIFI = function circleWIFI(index, icon, iconRevert)
    {
        wifiMarkerArray[index].setVisible(true);
        wifiMarkerArray[index].setIcon(icon);
        setTimeout(function () {
        wifiMarkerArray[index].setIcon(iconRevert);
        }, 100000);

    }

      document.circleAndNumberWIFI = function circleAndNumberWIFI(index, icon, number)
    {

        document.resetRetailerIcon = function resetRetailerIcon(icon) {
            for (i = 0; i < retailerMarkerArray.length; i++) {
                retailerMarkerArray[i].setIcon(icon);
            }
        }

        document.circleAndNumberWIFI = function circleAndNumberWIFI(index, icon, number) {


        wifiMarkerArray[index].setVisible(true);
        wifiMarkerArray[index].setIcon(icon);
        wifiMarkerArray[index].setLabel({text: number,
                                        color: "#eb3a44",
                                        fontSize: "18px",
                                        fontWeight: "bold"});

    }

     document.circleAndNumberRetailer = function circleAndNumberRetailer(index, icon, number)
    {



        retailerMarkerArray[index].setVisible(true);
        retailerMarkerArray[index].setIcon(icon);
        retailerMarkerArray[index].setLabel({text: number,
                                        color: "#eb3a44",
                                        fontSize: "18px",
                                        fontWeight: "bold"});

    }


    document.circlePoint = function circlePoint(latLng)
    {
    var circledPoint = new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: latLng,
            radius: 30
          });
          circleArray.push(circledPoint);
    }




    /* Generic add marker function  takes LatLng literal, icon path and title
       returns the created marker.
      */
    document.addMarker = function addMarker(latlng, icon, title)
    {
        var marker = new google.maps.Marker({
          position: latlng,
          map: map,
          icon: icon,
          title: title,
          noSupress: true //<-- here we tell InfoWindow to bypass our blocker
           });
        return marker;
    }

    /* Creates a wifiMarker using addMarker.Takes LatLng literal, icon path and title.
       Adds the created marker to wifiMarkerArray.
    */
    document.addWIFIMarker = function addWIFIMarker(latlng, icon, title)
    {
        var marker = document.addMarker(latlng, icon, title);
        wifiMarkerArray.push(marker);
    }

    /* Creates a retailerMarker using addMarker.Takes LatLng literal, icon path and title.
       Adds the created marker to retailerMarkerArray.
    */
    document.addRetailerMarker = function addRetailerMarker(latlng, icon, title)
    {
        var marker = document.addMarker(latlng, icon, title);
                        marker.addListener('click', function() {
          retailerListner.wifiToRetailer(marker.position.lat(), marker.position.lng());

        });
        retailerMarkerArray.push(marker);
    }



    /* UpdateswifiMarkerCluster to include only markers that getVisible returns
       true for. Note this must iterate through entire wifiMarkerArray.
    */
    document.updatewifiMarkerCluster = function updatewifiMarkerCluster()
    {

        var newCluster = [];

        for (index = 0; index < wifiMarkerArray.length; ++index) {
            if(wifiMarkerArray[index].getVisible()) {
                newCluster.push(wifiMarkerArray[index]);
            }
        }
        wifiMarkerCluster.clearMarkers();
        wifiMarkerCluster.addMarkers(newCluster, false);
        wifiMarkerCluster.redraw();
    }


    /* UpdatesRetailerMarkerCluster to include only markers that getVisible returns
       true for. Note this must iterate through entire retailerMarkerArray.
    */
    document.updateRetailerMarkerCluster = function updateRetailerMarkerCluster()
    {

        var newClusterRetailer = [];

        for (index = 0; index < retailerMarkerArray.length; ++index) {
            if(retailerMarkerArray[index].getVisible()) {
                newClusterRetailer.push(retailerMarkerArray[index]);
            }
        }
        retailerMarkerCluster.clearMarkers();
        retailerMarkerCluster.addMarkers(newClusterRetailer, false);
        retailerMarkerCluster.redraw();
    }

    /* Takes the index of a wifiMarker in wifiMarkerArray and hides
       the marker.
    */
    document.hideWIFIMarker = function hideWIFIMarker(index)
    {
        wifiMarkerArray[index].setVisible(false);

    }

    /* Takes the index of a wifiMarker in wifiMarkerArray and shows
       the marker.
    */
    document.showWIFIMarker = function showWIFIMarker(index)
    {
        wifiMarkerArray[index].setVisible(true);

    }

    /* Takes the index of a retailerMarker in retailerMarkerArray and hides
       the marker.
    */
    document.hideRetailerMarker = function hideRetailerMarker(index)
    {
        retailerMarkerArray[index].setVisible(false);

    }

    /* Takes the index of a retailerMarker in retailerMarkerArray and shows
       the marker.
    */
    document.showRetailerMarker = function showRetailerMarker(index)
    {
        retailerMarkerArray[index].setVisible(true);
    }


    // Increases the zoom level of the map.
    document.zoomIn = function zoomIn()
    {
        var zoomLevel = map.getZoom();
        if (zoomLevel <= 20) map.setZoom(zoomLevel + 1);
    }

    // Decreases the zoom level of the map.
    document.zoomOut = function zoomOut()
    {
        var zoomLevel = map.getZoom();
        if (zoomLevel > 0) map.setZoom(zoomLevel - 1);
    }

    // DOM listner
    google.maps.event.addDomListener(window, 'load', initialize);

    }
</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false">
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrALsvaGRKhQxRw6X5VvydPqA5wMfwDN8&callback=initMap">
</script>
</body>
</html>